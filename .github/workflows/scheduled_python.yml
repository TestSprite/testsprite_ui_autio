name: Nightly UI Test Suite

on:
  schedule:
    # 多个时间格式选择（北京时间 24:00）
    - cron: '0 16 * * *'      # UTC 16:00 = 北京时间 24:00
    
  workflow_dispatch:          # 手动触发
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  testsprite_ui_auto:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'  # 设置时区
    
    strategy:
      matrix:
        python-version: [3.8]
        shm-size: [2gb]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-html allure-pytest
        pip install selenium webdriver-manager
        pip install playwright asyncio
        pip install anyio
        pip install pytest-asyncio
        pip install pytest-tornasync
        pip install pytest-trio pytest-xdist
        # 如果有特定的测试依赖
        pip install requests beautifulsoup4
        playwright install      
        # 增加系统资源
        sudo apt-get update
        sudo apt-get install -y libgbm-dev libnss3
        #安装jq工具
        sudo apt-get install -y jq

    - name: Install Allure Commandline
      run: |
        # 安装Allure命令行工具
        sudo apt-get update
        wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
        tar -zxvf allure-2.27.0.tgz
        sudo mv allure-2.27.0 /opt/allure
        sudo ln -s /opt/allure/bin/allure /usr/bin/allure
        allure --version
               
    - name: Run UI test cases
      run: |
        echo "开始运行 UI 测试..."
        # 运行测试并生成JSON报告，同时捕获退出码
        xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24"  pytest pytest_runcase_ui.py || echo "测试执行完成"
        echo "TEST_EXIT_CODE=$?" >> $GITHUB_ENV

    - name: Debug - Check report content
      if: always()
      run: |
        echo "=== 调试信息 ==="
        echo "pytest退出码: ${{ env.TEST_EXIT_CODE }}"
        if [ -f "./results/report.json" ]; then
          echo "报告文件存在，内容预览:"
          head -50 results/report.json
        else
          echo "未找到results/report.json"
          echo "results目录内容:"
          ls -la results/ 2>/dev/null || echo "results目录不存在"
        fi
        echo "失败测试数量: $FAILED_COUNT"
        echo "pytest退出码: ${{ env.TEST_EXIT_CODE }}"

        # 设置输出变量
        echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT

        # 如果有失败测试，创建Linear issue
        if [ "$FAILED_COUNT" -gt 0 ]; then
          echo "检测到 $FAILED_COUNT 个失败测试，开始创建Linear issue..."

          # 创建Linear issue的API调用
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d '{
              "query": "mutation IssueCreate { issueCreate(input: { title: \"UI自动化测试失败: '"$FAILED_COUNT"'个用例失败\", description: \"GitHub Actions测试运行失败报告\\n\\n**失败详情:**\\n- 失败用例数量: '"$FAILED_COUNT"'\\n- 工作流: '"${{ github.workflow }}"'\\n- 提交: '"${{ github.sha }}"'\\n- 分支: '"${{ github.ref }}"'\\n- 运行时间: '"$(date)"'\\n\\n**相关链接:**\\n- 工作流运行: '"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"'\\n- 提交详情: '"${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"'\\n\", teamId: \"'"$LINEAR_TEAM_ID"'\", labelIds: [\"\"], priority: 2 }) { success issue { id title number url } } }"
            }' \
            https://api.linear.app/graphql 2>/dev/null || echo "API请求失败")

          if echo "$RESPONSE" | grep -q "success"; then
            echo "✅ Linear issue创建成功"
            ISSUE_URL=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.url // empty' 2>/dev/null || echo "")
            if [ -n "$ISSUE_URL" ]; then
              echo "Issue链接: $ISSUE_URL"
            fi
          else
            echo "❌ Linear issue创建失败"
            echo "响应: $RESPONSE"
          fi
        else
          echo "✅ 所有测试通过，无需创建Linear issue"
        fi
      env:
        # 确保在CI环境中使用无头模式
        HEADLESS: true
        PLAYWRIGHT_HEADLESS: 1
        LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}